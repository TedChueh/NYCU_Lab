	ORG 00H
	AJMP INIT
	ORG 50H

SEG_DATA:
	DB 03H
	DB 09FH
	DB 025H
	DB 0DH
	DB 099H
	DB 049H
	DB 041H
	DB 01FH
	DB 01H
	DB 09H
	DB 011H 
	DB 0C1H 
	DB 063H
	DB 085H 
	DB 061H
	DB 071H
	DB 0FFH

KEYPAD:
	DB 00H
	DB 04H  
	DB 08H 
	DB 0CH  

	DB 01H  
	DB 05H  
	DB 09H   
	DB 0DH

	DB 02H  
	DB 06H  
	DB 0AH
	DB 0EH

	DB 03H   
	DB 07H  
	DB 0BH  
	DB 0FH

	DB 010H ; No key pressed

INIT:
    MOV TMOD, #01H 
    MOV R0, #010H ;Col Detection
	MOV R1, #00H  ;Row Detection
	MOV R2, #00H  ;Temp For Row Detection
	MOV R3, #00H  ;Display Shift Control
    MOV P0, #0FFH ;Keypad Input
	MOV P1, #0FFH ;Segment Output
	MOV P2, #11111110B ;Display IO Control

LOOP:
    ACALL DETECT
	ACALL DISPLAY
	JMP LOOP

DETECT:
	MOV R0, #010H
	MOV R1, #00H

DETECTCOL0:
    MOV P0, #07FH
	ACALL DELAY
	MOV A, P0
    ANL A, #0FH
	MOV R2, A
	CLR C
	SUBB A, #0FH
    JZ DETECTCOL1
	MOV R0, #00H
	ACALL DETECTROW
	RET

DETECTCOL1:
	MOV P0, #0BFH
	ACALL DELAY
	MOV A, P0
	ANL A, #0FH
	MOV R2, A
	CLR C
	SUBB A, #0FH
	JZ DETECTCOL2
	MOV R0, #04H
	ACALL DETECTROW
	RET

DETECTCOL2:
	MOV P0, #0DFH
	ACALL DELAY
	MOV A, P0
	ANL A, #0FH
	MOV R2, A
	CLR C
	SUBB A, #0FH
	JZ DETECTCOL3	
	MOV R0, #08H
	ACALL DETECTROW
	RET

DETECTCOL3:
	MOV P0, #0EFH
	ACALL DELAY
	MOV A, P0
	ANL A, #0FH
	MOV R2, A
	CLR C
	SUBB A, #0FH
	JZ DEFAULT_NOPRESSED
	MOV R0, #0CH
	ACALL DETECTROW
	RET
;------------------------------------------------------------------

DEFAULT_NOPRESSED:
	RET

DETECTROW:
	CJNE R2, #0EH,  NOTPRESSEDROW0
	MOV R1, #00H
	RET

NOTPRESSEDROW0:
	CJNE R2, #0DH,  NOTPRESSEDROW1
	MOV R1, #01H
	RET

NOTPRESSEDROW1:
	CJNE R2, #0BH,  NOTPRESSEDROW2
	MOV R1, #02H
	RET

NOTPRESSEDROW2:
	CJNE R2, #07H,  DEFAULT
	MOV R1, #03H
	RET

DEFAULT:
	RET
;------------------------------------------------------------------

DISPLAY:
	CLR C
	MOV A, R0
	SUBB A, #010H
	JZ TURNOFFDISPLAY

DISPLAY0:
	CJNE R3, #00H, DISPLAY1
	MOV P2, #11111110B 
	MOV DPTR, #KEYPAD
	MOV A, R0
	ADD A, R1
	MOVC A, @A+DPTR
	CLR C
	SUBB A, #0AH
	JNC  DISPLAY0OVER9
	MOV DPTR, #KEYPAD
	MOV A, R0
	ADD A, R1
	MOVC A, @A+DPTR
	MOV DPTR, #SEG_DATA
	MOVC A, @A+DPTR
	MOV P1, A
	MOV R3, #01H
	RET

DISPLAY0OVER9:
	MOV DPTR, #SEG_DATA
	MOVC A, @A+DPTR
	MOV P1, A
	MOV R3, #01H
	RET

DISPLAY1:
	CJNE R3, #01H, DISPLAY1
	MOV P2, #11111101B 
	MOV DPTR, #KEYPAD
	MOV A, R0
	ADD A, R1
	MOVC A, @A+DPTR
	CLR C
	SUBB A, #0AH
	JNC  DISPLAY1OVER9
	MOV P1, #0FFH
	MOV R3, #00H
	RET

DISPLAY1OVER9:
	MOV DPTR, #SEG_DATA
	MOV  A, #01H
	MOVC A, @A+DPTR
	MOV  P1, A
	MOV R3, #00H
	RET
	
TURNOFFDISPLAY:
	MOV P2, #0FFH
	RET
;------------------------------------------------------------------

DELAY:
	MOV TH0, #0FBH
	MOV TL0, #0CEH
	SETB TR0	
	JNB TF0, $
	CLR TR0
	CLR TF0
	RET
	END